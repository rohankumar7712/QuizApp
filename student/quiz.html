<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f4f6fa; font-family: 'Segoe UI', sans-serif; }
    .quiz-container { max-width: 700px; margin: auto; margin-top: 50px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .option-btn { width: 100%; margin: 8px 0; text-align: left; }
    .timer { font-weight: bold; color: #c0392b; }
    .hidden { display: none; }
    .question-text { font-size: 18px; font-weight: 500; }
    .progress-bar-wrapper { height: 10px; background: #ddd; border-radius: 5px; overflow: hidden; margin-bottom: 10px; }
    .progress-bar-inner { height: 100%; background: #3498db; width: 100%; transition: width 1s linear; }
  </style>
</head>
<body>

<div class="quiz-container">
  <h3 id="quizTitle"></h3>
  <p id="quizDescription" class="text-muted mb-3"></p>
  <div class="progress-bar-wrapper">
    <div id="quizProgress" class="progress-bar-inner"></div>
  </div>
  <div class="d-flex justify-content-between align-items-center mb-2">
    <span>Question <span id="currentQ"></span> of <span id="totalQ"></span></span>
    <span class="timer">‚è± <span id="timeLeft"></span></span>
  </div>
  <hr>
  <div id="questionBox" class="mb-3"></div>
  <div id="optionsBox"></div>
  <button id="nextBtn" class="btn btn-primary mt-3">Next</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    updateDoc,
    arrayUnion,
    Timestamp
  } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC_lvF65P7vaKYnKEMrpHfJroMe-vh3w4U",
    authDomain: "quizapp-f370d.firebaseapp.com",
    projectId: "quizapp-f370d",
    storageBucket: "quizapp-f370d.appspot.com",
    messagingSenderId: "822956185807",
    appId: "1:822956185807:web:3d2244d53f9bb61ec33fba"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const urlParams = new URLSearchParams(window.location.search);
  const quizCode = urlParams.get("code");
  const studentName = localStorage.getItem("studentName");

  if (!quizCode || !studentName) {
    alert("Missing quiz code or student not logged in.");
    window.location.href = "dashboard.html";
  }

  const quizTitle = document.getElementById("quizTitle");
  const quizDescription = document.getElementById("quizDescription");
  const questionBox = document.getElementById("questionBox");
  const optionsBox = document.getElementById("optionsBox");
  const nextBtn = document.getElementById("nextBtn");
  const currentQ = document.getElementById("currentQ");
  const totalQ = document.getElementById("totalQ");
  const timeLeft = document.getElementById("timeLeft");
  const quizProgress = document.getElementById("quizProgress");

  let quizData = {};
  let currentQuestionIndex = 0;
  let answers = [];
  let questionTimer;
  let remainingTime;

  async function loadQuiz() {
    const quizRef = doc(db, "quizzes", quizCode);
    const quizSnap = await getDoc(quizRef);
    if (!quizSnap.exists()) {
      alert("Quiz not found!");
      return;
    }

    quizData = quizSnap.data();
    const questions = quizData.questions || [];

    quizTitle.textContent = quizData.title;
    quizDescription.textContent = quizData.description || "";
    totalQ.textContent = questions.length;

    showQuestion();
  }

  function showQuestion() {
    clearInterval(questionTimer);

    const q = quizData.questions[currentQuestionIndex];
    if (!q) {
      submitQuiz();
      return;
    }

    currentQ.textContent = currentQuestionIndex + 1;
    const isCodeQuestion = /[;{}()=<>]/.test(q.question);
const questionHTML = isCodeQuestion
  ? `<pre class="question-text"><code>${q.question}</code></pre>`
  : `<div class="question-text">${q.question}</div>`;
questionBox.innerHTML = questionHTML;

    optionsBox.innerHTML = "";

    const optionKeys = ["a", "b", "c", "d"];
    optionKeys.forEach((key) => {
      if (q[key]) {
        const btn = document.createElement("button");
        btn.className = "btn btn-outline-dark option-btn";
        btn.textContent = q[key];
        btn.onclick = () => selectOption(key);
        optionsBox.appendChild(btn);
      }
    });

    if (answers[currentQuestionIndex]) {
      highlightSelectedOption(answers[currentQuestionIndex]);
    }

    // start per-question timer
    remainingTime = q.timeLimit || 15;
    updateTimerUI();

    questionTimer = setInterval(() => {
      remainingTime--;
      updateTimerUI();
      if (remainingTime <= 0) {
        clearInterval(questionTimer);
        saveAnswer();
        nextQuestion();
      }
    }, 1000);
  }

  function selectOption(key) {
    answers[currentQuestionIndex] = key;
    highlightSelectedOption(key);
  }

  function highlightSelectedOption(selectedKey) {
    const optionKeys = ["a", "b", "c", "d"];
    Array.from(optionsBox.children).forEach((btn, i) => {
      const key = optionKeys[i];
      btn.classList.remove("btn-primary", "btn-outline-dark");
      btn.classList.add(key === selectedKey ? "btn-primary" : "btn-outline-dark");
    });
  }

  function updateTimerUI() {
    timeLeft.textContent = `${remainingTime}s`;
    const total = quizData.questions[currentQuestionIndex].timeLimit || 15;
    const percent = (remainingTime / total) * 100;
    quizProgress.style.width = `${percent}%`;
  }

  nextBtn.addEventListener("click", () => {
    saveAnswer();
    nextQuestion();
  });

  function nextQuestion() {
    if (currentQuestionIndex < quizData.questions.length - 1) {
      currentQuestionIndex++;
      showQuestion();
    } else {
      submitQuiz();
    }
  }

  function saveAnswer() {
    if (!answers[currentQuestionIndex]) {
      answers[currentQuestionIndex] = "Not Answered";
    }
  }

  async function submitQuiz() {
    clearInterval(questionTimer);
    nextBtn.disabled = true;

    let score = 0;
    const reviewAnswers = [];

    quizData.questions.forEach((q, i) => {
      const correctKey = q.correct;
      const selectedKey = answers[i] ?? "Not Answered";

      if (selectedKey === correctKey) {
        score += quizData.markPerQuestion || 1;
      }

      reviewAnswers.push({
        question: q.question,
        selected: selectedKey,
        correct: correctKey,
        options: { a: q.a, b: q.b, c: q.c, d: q.d }
      });
    });

    await setDoc(doc(db, `review_${quizCode}`, studentName), {
      student: studentName,
      quizCode,
      score,
      total: quizData.questions.length * (quizData.markPerQuestion || 1),
      answers: reviewAnswers,
      submittedAt: Timestamp.now()
    });

    const leaderboardRef = doc(db, "leaderboards", quizCode);
    await updateDoc(leaderboardRef, {
      entries: arrayUnion({ name: studentName, score })
    }).catch(async () => {
      await setDoc(leaderboardRef, {
        entries: [{ name: studentName, score }]
      });
    });

    window.location.href = "history.html";
  }

  loadQuiz();
</script>

</body>
</html>
