<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Quiz</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background: #f4f6fa; font-family: 'Segoe UI', sans-serif; }
.quiz-container { max-width: 700px; margin: auto; margin-top: 50px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.option-btn { width: 100%; margin: 8px 0; text-align: left; }
.timer { font-weight: bold; color: #c0392b; }
.question-text { font-size: 18px; font-weight: 500; }
.progress-bar-wrapper { height: 10px; background: #ddd; border-radius: 5px; overflow: hidden; margin-bottom: 10px; }
.progress-bar-inner { height: 100%; background: #3498db; width: 100%; transition: width 1s linear; }
</style>
</head>
<body>

<div class="quiz-container">
  <h3 id="quizTitle"></h3>
  <p id="quizDescription" class="text-muted mb-3"></p>
  <div class="progress-bar-wrapper">
    <div id="quizProgress" class="progress-bar-inner"></div>
  </div>
  <div class="d-flex justify-content-between align-items-center mb-2">
    <span>Question <span id="currentQ"></span> of <span id="totalQ"></span></span>
    <span class="timer">⏱ <span id="timeLeft"></span></span>
  </div>
  <hr>
  <div id="questionBox" class="mb-3"></div>
  <div id="optionsBox"></div>
  <button id="nextBtn" class="btn btn-primary mt-3">Next</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, Timestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

const firebaseConfig = { 
  apiKey:"AIzaSyC_lvF65P7vaKYnKEMrpHfJroMe-vh3w4U", 
  authDomain:"quizapp-f370d.firebaseapp.com", 
  projectId:"quizapp-f370d", 
  storageBucket:"quizapp-f370d.appspot.com", 
  messagingSenderId:"822956185807", 
  appId:"1:822956185807:web:3d2244d53f9bb61ec33fba" 
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const urlParams = new URLSearchParams(window.location.search);
const quizCode = urlParams.get("code");
const studentName = localStorage.getItem("studentName");
if (!quizCode || !studentName) { 
  alert("Missing quiz code or student not logged in."); 
  window.location.href = "dashboard.html"; 
}

const quizTitle = document.getElementById("quizTitle");
const quizDescription = document.getElementById("quizDescription");
const questionBox = document.getElementById("questionBox");
const optionsBox = document.getElementById("optionsBox");
const nextBtn = document.getElementById("nextBtn");
const currentQ = document.getElementById("currentQ");
const totalQ = document.getElementById("totalQ");
const timeLeft = document.getElementById("timeLeft");
const quizProgress = document.getElementById("quizProgress");

let quizData = {}, currentQuestionIndex = 0, answers = [], questionTimer, remainingTime, tabSwitchCount = 0, quizSubmitted = false;

const savedAnswers = localStorage.getItem(`quiz_${quizCode}_answers`);
if (savedAnswers) answers = JSON.parse(savedAnswers);

history.pushState(null, null, location.href);
window.addEventListener("popstate", () => { history.pushState(null, null, location.href); alert("You cannot go back during the quiz!"); });
document.addEventListener("contextmenu", e => e.preventDefault());
document.addEventListener("keydown", e => { 
  if ((e.ctrlKey && e.key === "t") || (e.ctrlKey && e.key === "Tab") || e.altKey) { e.preventDefault(); alert("This action is disabled!"); } 
  if (e.key === "F12" || (e.ctrlKey && e.shiftKey && ["I","C"].includes(e.key))) { e.preventDefault(); alert("Developer tools disabled!"); } 
});
document.addEventListener("visibilitychange", () => { 
  if (quizSubmitted) return; 
  if (document.hidden) { 
    tabSwitchCount++; 
    if (tabSwitchCount >= 2) { 
      alert("Tab switch limit reached! Quiz submitted."); 
      submitQuiz(); 
    } else { 
      alert("Switching tabs not allowed. One more switch will auto-submit."); 
    } 
  } 
});
window.addEventListener("beforeunload", e => { 
  if (quizSubmitted) return; 
  e.preventDefault(); 
  e.returnValue = "Your quiz will be submitted!"; 
});

async function loadQuiz() {
  const quizSnap = await getDoc(doc(db, "quizzes", quizCode));
  if (!quizSnap.exists()) { alert("Quiz not found!"); return; }

  quizData = quizSnap.data();
  const allQuestions = quizData.questions || [];
  const totalAllowed = quizData.totalQuestions || allQuestions.length;

  // ✅ Randomly select N questions based on totalQuestions
  const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
  quizData.questions = shuffled.slice(0, totalAllowed);

  quizTitle.textContent = quizData.title;
  quizDescription.textContent = quizData.description || "";
  totalQ.textContent = quizData.questions.length;

  showQuestion();
}

function showQuestion() {
  clearInterval(questionTimer);
  const q = quizData.questions[currentQuestionIndex];
  if (!q) { submitQuiz(); return; }
  currentQ.textContent = currentQuestionIndex + 1;
  questionBox.innerHTML = /[;{}()=<>]/.test(q.question) 
    ? `<pre class="question-text"><code>${q.question}</code></pre>` 
    : `<div class="question-text">${q.question}</div>`;
  
  optionsBox.innerHTML = "";
  ["a","b","c","d"].forEach(key => { 
    if(q[key]) { 
      const btn = document.createElement("button"); 
      btn.className="btn btn-outline-dark option-btn"; 
      btn.textContent=q[key]; 
      btn.onclick=()=>selectOption(key); 
      optionsBox.appendChild(btn); 
    } 
  });
  
  if (answers[currentQuestionIndex]) highlightSelectedOption(answers[currentQuestionIndex]);
  remainingTime = q.timeLimit || 15;
  updateTimerUI();
  questionTimer = setInterval(() => { 
    remainingTime--; 
    updateTimerUI(); 
    if (remainingTime <= 0) { 
      clearInterval(questionTimer); 
      saveAnswer(); 
      nextQuestion(); 
    } 
  }, 1000);
}

function selectOption(key) { 
  answers[currentQuestionIndex] = key; 
  highlightSelectedOption(key); 
  localStorage.setItem(`quiz_${quizCode}_answers`, JSON.stringify(answers)); 
}
function highlightSelectedOption(selectedKey) { 
  ["a","b","c","d"].forEach((key,i)=>{ 
    const btn=optionsBox.children[i]; 
    if(!btn)return; 
    btn.classList.remove("btn-primary","btn-outline-dark"); 
    btn.classList.add(key===selectedKey?"btn-primary":"btn-outline-dark"); 
  }); 
}
function updateTimerUI() { 
  timeLeft.textContent=`${remainingTime}s`; 
  const total=quizData.questions[currentQuestionIndex].timeLimit||15; 
  quizProgress.style.width=`${(remainingTime/total)*100}%`; 
}
nextBtn.addEventListener("click",()=>{ saveAnswer(); nextQuestion(); });
function nextQuestion(){ 
  if(currentQuestionIndex<quizData.questions.length-1){
    currentQuestionIndex++;showQuestion();
  }else{
    submitQuiz();
  } 
}
function saveAnswer(){ if(!answers[currentQuestionIndex]) answers[currentQuestionIndex]="Not Answered"; }

setInterval(async ()=>{
  if(!quizData.questions||quizSubmitted) return;
  await setDoc(doc(db, `autosave_${quizCode}`, studentName), { answers, lastSavedAt: Timestamp.now() }, { merge:true });
},5000);

async function submitQuiz() {
  clearInterval(questionTimer);
  nextBtn.disabled = true;
  let score=0, reviewAnswers=[];
  quizData.questions.forEach((q,i)=>{
    const correctKey=q.correct;
    const selectedKey=answers[i]??"Not Answered";
    if(selectedKey===correctKey) score+=quizData.markPerQuestion||1;
    reviewAnswers.push({ question:q.question, selected:selectedKey, correct:correctKey, options:{a:q.a,b:q.b,c:q.c,d:q.d} });
  });
  await setDoc(doc(db, `review_${quizCode}`, studentName), { 
    student:studentName, 
    quizCode, 
    score, 
    total:quizData.questions.length*(quizData.markPerQuestion||1), 
    answers:reviewAnswers, 
    submittedAt:Timestamp.now() 
  });
  const leaderboardRef=doc(db,"leaderboards",quizCode);
  await updateDoc(leaderboardRef,{ entries: arrayUnion({ name:studentName, score }) })
  .catch(async()=>{ await setDoc(leaderboardRef,{ entries:[{ name:studentName, score }] }); });

  // Remove quiz from reattempts after submission
  const allowanceRef = doc(db,"quizzesAllownce",studentName);
  await updateDoc(allowanceRef,{ reattempts: arrayRemove(quizCode) });

  quizSubmitted = true;
  window.location.href="takeQuiz.html";
}

loadQuiz();
</script>
</body>
</html>
