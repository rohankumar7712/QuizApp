<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(to right, #f0f4ff, #e6f0ff);
  margin: 0;
  padding: 0;
}

/* Sidebar */
.sidebar {
  min-height: 100vh;
  background: linear-gradient(180deg, #6f42c1, #8e44ad);
  color: white;
  padding: 20px;
}
.sidebar h4 { font-weight: bold; margin-bottom: 30px; font-size: 1.5rem; }
.sidebar a {
  color: white;
  text-decoration: none;
  display: block;
  padding: 12px;
  border-radius: 10px;
  transition: 0.3s;
  font-weight: 500;
}
.sidebar a:hover, .sidebar a.active { background-color: rgba(255,255,255,0.15); }
.sidebar a.logout-link { color: #ffcccc !important; }
.sidebar a.logout-link:hover { background-color: #c0392b; color: white !important; }
.toggle-btn { display: none; font-size: 1.2rem; }

/* Scoreboard */
.scoreboard-card {
  border-radius: 16px;
  background: linear-gradient(145deg, #ffffff, #f2f5ff);
  padding: 25px;
  box-shadow: 0 6px 15px rgba(0,0,0,0.1);
}
.scoreboard-card h4 { font-weight: 700; margin-bottom: 20px; }
.table th { background-color: #6f42c1; color: white; }
.table tr:hover { background-color: #f1ebff; }

/* Status Badges */
.status-pass { color: #28a745; font-weight: bold; }
.status-fail { color: #dc3545; font-weight: bold; }

/* Responsive */
@media (max-width: 768px) {
  .sidebar { position: fixed; width: 220px; z-index: 1000; transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
  .sidebar.show { transform: translateX(0); }
  .toggle-btn { display: block; background-color: #6f42c1; color: white; border: none; padding: 10px 15px; margin: 10px; border-radius: 8px; }
}
</style>
</head>
<body>

<button class="toggle-btn" onclick="toggleSidebar()">‚ò∞ Menu</button>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 sidebar" id="sidebar">
      <h4>Student Panel</h4>
      <a class="nav-link active" href="dashboard.html">Dashboard</a>
      <a class="nav-link" href="takeQuiz.html">Take Quiz</a>
      <a class="nav-link" href="history.html">Quiz History</a>
      <hr class="text-white">
      <a class="nav-link logout-link" href="../index.html" onclick="logout()">Logout</a>
    </div>

    <!-- Main Content -->
    <div class="col-md-9 p-4">
      <h3 class="mb-4">Welcome, <span id="studentName">Student</span>!</h3>

      <!-- Scoreboard -->
      <div class="scoreboard-card">
        <h4>üìã Quiz Scoreboard</h4>
        <div class="table-responsive">
          <table class="table table-bordered table-striped align-middle">
            <thead>
              <tr>
                <th>Quiz Name</th>
                <th>Total Marks</th>
                <th>Gained Marks</th>
                <th>Status</th>
                <th>Rank</th>
                <th>Submitted On</th>
              </tr>
            </thead>
            <tbody id="scoreboardBody">
              <tr><td colspan="6" class="text-center text-muted">Loading quizzes...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_lvF65P7vaKYnKEMrpHfJroMe-vh3w4U",
  authDomain: "quizapp-f370d.firebaseapp.com",
  projectId: "quizapp-f370d",
  storageBucket: "quizapp-f370d.appspot.com",
  messagingSenderId: "822956185807",
  appId: "1:822956185807:web:3d2244d53f9bb61ec33fba"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const studentName = localStorage.getItem("studentName");
if (!studentName) { alert("Not logged in"); window.location = "../index.html"; }
document.getElementById("studentName").textContent = studentName;

function toggleSidebar() { document.getElementById("sidebar").classList.toggle("show"); }
window.toggleSidebar = toggleSidebar;

function logout() { localStorage.clear(); window.location.href = "../index.html"; }
window.logout = logout;

// ‚úÖ Load only attempted quizzes sorted by submission time
async function loadScoreboard() {
  const quizzesSnap = await getDocs(collection(db, "quizzes"));
  const studentsSnap = await getDocs(collection(db, "students"));
  const tbody = document.getElementById("scoreboardBody");
  tbody.innerHTML = "";

  const attempted = [];

  for (const quizDoc of quizzesSnap.docs) {
    const quizData = quizDoc.data();
    const quizId = quizDoc.id;
    const quizName = quizData.title || quizId;

    const reviewSnap = await getDoc(doc(db, `review_${quizId}`, studentName));
    if (!reviewSnap.exists()) continue; // only attempted quizzes

    const review = reviewSnap.data();
    const submittedDate = review.submittedAt?.toDate?.();
    const submittedAtStr = submittedDate ? submittedDate.toLocaleString() : "N/A";
    const submittedSeconds = review.submittedAt?.seconds || 0;

    const totalQuestions = quizData.questions ? quizData.questions.length : 0;
    const totalMarks = totalQuestions;
    const gainedMarks = review.score || 0;
    const percentage = totalMarks > 0 ? (gainedMarks / totalMarks) * 100 : 0;
    const status = percentage >= 40
      ? `<span class="status-pass">Pass ‚úÖ</span>`
      : `<span class="status-fail">Fail ‚ùå</span>`;

    // Collect all student performances for ranking
    const studentResults = [];
    for (const studentDoc of studentsSnap.docs) {
      const sName = studentDoc.data().name;
      const sReviewSnap = await getDoc(doc(db, `review_${quizId}`, sName));
      if (sReviewSnap.exists()) {
        const sData = sReviewSnap.data();
        studentResults.push({
          name: sName,
          score: sData.score || 0,
          time: sData.submittedAt?.seconds || 9999999999
        });
      }
    }

    studentResults.sort((a, b) => {
      if (b.score !== a.score) return b.score - a.score;
      return a.time - b.time;
    });

    const rankIndex = studentResults.findIndex(s => s.name === studentName);
    const rank = rankIndex >= 0 ? rankIndex + 1 : "N/A";

    attempted.push({ quizName, totalMarks, gainedMarks, status, rank, submittedAtStr, submittedSeconds });
  }

  // ‚úÖ Sort by actual submission time
  attempted.sort((a, b) => a.submittedSeconds - b.submittedSeconds);

  if (attempted.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">You have not attempted any quizzes yet.</td></tr>`;
    return;
  }

  attempted.forEach(q => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${q.quizName}</td>
      <td>${q.totalMarks}</td>
      <td>${q.gainedMarks}</td>
      <td>${q.status}</td>
      <td>${q.rank}</td>
      <td><small class="text-muted">${q.submittedAtStr}</small></td>
    `;
    tbody.appendChild(row);
  });
}

loadScoreboard();
window.addEventListener("focus", loadScoreboard);
</script>

</body>
</html>
